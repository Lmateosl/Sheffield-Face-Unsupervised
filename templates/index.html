{% extends "base.html" %}

{% block title %}UMIST Face Explorer{% endblock %}

{% block content %}
<header class="hero">
    <div class="pill pill-ghost">UMIST Faces Â· Unsupervised pipeline</div>
    <h1>Try the Face Cluster Classifier</h1>
    <p class="lede">
        Upload a face image, and the FastAPI backend will project it through PCA, cluster it,
        and predict the most likely person group in the UMIST dataset.
    </p>
    <div class="hero-actions">
        <button class="btn-secondary" type="button" id="show-report">View analysis report (inline)</button>
    </div>
    <div class="status-row">
        <div class="status-badge {{ 'online' if api_status else 'offline' }}">
            <span class="dot"></span>
            <span>{{ api_status_msg or 'API status unknown' }}</span>
        </div>
        <div class="hint">API base: {{ config.API_BASE_URL if config.API_BASE_URL else 'http://127.0.0.1:8000' }}</div>
    </div>
</header>

<section id="analysis-report" class="card report-card collapsed">
    <div class="card-header">
        <div>
            <p class="pill pill-solid secondary">Analysis report</p>
            <h2>Project documentation</h2>
            <p class="dim">Rendered inline from the PDF for quick reference.</p>
        </div>
    </div>
    <div id="report-frame-wrap">
        <iframe id="report-frame" src="" data-report-url="{{ url_for('analysis_report') }}" class="report-frame" title="Analysis report" loading="lazy"></iframe>
        <p class="dim tiny">If the PDF does not render, <a href="{{ url_for('analysis_report') }}">open the report directly</a>.</p>
    </div>
</section>

<main class="layout">
    <section class="card upload-card">
        <div class="card-header">
            <div>
                <p class="pill pill-solid">Upload &amp; predict</p>
                <h2>Run an inference</h2>
                <p class="dim">PNG Â· JPG Â· JPEG Â· BMP Â· GIF Â· WEBP Â· up to 6MB</p>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-area">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data" class="upload-form">
            <label for="image-input" class="dropzone" id="dropzone">
                <div class="drop-inner">
                    <div class="drop-icon">â¬†</div>
                    <div>
                        <strong>Drop an image</strong> or click to browse
                        <p class="dim">We will convert to grayscale 112Ã—92 to match training.</p>
                    </div>
                </div>
                <input type="file" name="image" id="image-input" accept="image/*" required>
            </label>
            <div class="form-footer">
                <div id="file-name" class="dim">No file selected yet.</div>
                <button type="submit" class="btn-primary">Run model</button>
            </div>
        </form>

        {% if examples %}
            <div class="examples-head">
                <div class="examples-top">
                    <p class="dim">Or pick a UMIST example:</p>
                    <div class="category-toggle">
                        {% for cat in categories %}
                            <a class="cat-chip {{ 'active' if cat.key == selected_category else '' }}" href="{{ url_for('index', category=cat.key) }}">{{ cat.label }}</a>
                        {% endfor %}
                    </div>
                </div>
                <div class="example-grid">
                    {% for ex in examples %}
                        <form class="example-card" action="{{ url_for('predict_example') }}" method="post">
                            <input type="hidden" name="example_id" value="{{ ex.id }}">
                            <input type="hidden" name="category" value="{{ selected_category }}">
                            <button type="submit" class="example-btn">
                                <img src="data:image/png;base64,{{ ex.preview_b64 }}" alt="Person {{ ex.person }} sample {{ ex.sample }}">
                                <div class="example-meta">
                                    <span class="pill pill-ghost">Person {{ ex.person }}</span>
                                    <span class="dim tiny">Sample {{ ex.sample }}</span>
                                </div>
                            </button>
                        </form>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </section>

    <section class="card results-card">
        <div class="card-header">
            <div>
                <p class="pill pill-solid secondary">Prediction</p>
                <h2>Model output</h2>
                <p class="dim">We show the predicted person group and the top confidences.</p>
            </div>
        </div>
        {% if result %}
            <div class="result-main">
                <div>
                    <p class="dim">Predicted person/group</p>
                    <div class="prediction">{{ result.predicted_group_1_based }}</div>
                    <div class="tiny">0-based label: {{ result.predicted_label_0_based }}</div>
                </div>
                {% if top_probs and top_probs|length > 0 %}
                    <div class="confidence">
                        <p class="dim">Confidence</p>
                        <div class="pill pill-solid">
                            {{ (top_probs[0].prob * 100) | round(2) }}%
                        </div>
                    </div>
                {% endif %}
            </div>

            {% if preview_data %}
                <div class="preview-block">
                    <p class="dim">Submitted image</p>
                    <img src="data:image/*;base64,{{ preview_data }}" alt="Uploaded preview">
                </div>
            {% endif %}

            {% if top_probs %}
                <div class="top-probabilities">
                    {% for item in top_probs %}
                        <div class="bar-row">
                            <div class="bar-label">Group {{ item.group }}</div>
                            <div class="bar">
                                <span style="width: {{ (item.prob * 100) | round(2) }}%;"></span>
                            </div>
                            <div class="bar-value">{{ (item.prob * 100) | round(2) }}%</div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="details-grid">
                <div class="detail-card">
                    <div class="card-header small">
                        <div>
                            <p class="pill pill-solid secondary">Confidence summary</p>
                            <h3>Model certainty</h3>
                            <p class="dim tiny">Based on probability entropy.</p>
                        </div>
                    </div>
                    <div class="certainty-wrap">
                        <div class="certainty-chip {{ certainty.label|lower }}">
                            {{ certainty.label }} certainty
                        </div>
                        {% if certainty.certainty_pct is not none %}
                            <div class="certainty-bar">
                                <span style="width: {{ (certainty.certainty_pct * 100) | round(1) }}%"></span>
                            </div>
                            <div class="dim tiny">Certainty: {{ (certainty.certainty_pct * 100) | round(1) }}% Â· Entropy: {{ certainty.entropy | round(3) }} bits</div>
                        {% endif %}
                    </div>
                </div>

                <div class="detail-card">
                    <div class="card-header small">
                        <div>
                            <p class="pill pill-solid secondary">Prediction details</p>
                            <h3>Run report</h3>
                            <p class="dim tiny">Key facts from this inference.</p>
                        </div>
                    </div>
                    <div class="kv-grid">
                        <div><span class="dim tiny">Predicted group</span><strong>Person {{ result.predicted_group_1_based }}</strong></div>
                        <div><span class="dim tiny">Top-1 prob</span>
                            <strong>
                                {% if top_probs and top_probs|length > 0 %}
                                    {{ (top_probs[0].prob * 100) | round(2) }}%
                                {% else %}
                                    n/a
                                {% endif %}
                            </strong>
                        </div>
                        <div><span class="dim tiny">Classes</span><strong>{{ result.probabilities|length }}</strong></div>
                        <div><span class="dim tiny">Category source</span><strong>{{ selected_category|capitalize }}</strong></div>
                    </div>
                </div>
            </div>

            <div class="pipeline-card">
                <div class="card-header small">
                    <div>
                        <p class="pill pill-solid secondary">Feature pipeline</p>
                        <h3>What the model does</h3>
                        <p class="dim tiny">Steps applied before classification.</p>
                    </div>
                </div>
                <div class="pipeline-badges">
                    {% for step in pipeline_steps %}
                        <span class="pipeline-chip">{{ step }}</span>
                    {% endfor %}
                </div>
            </div>

            {% if ranked_probs %}
                <div class="table-wrap">
                    <div class="table-head">
                        <span>Rank</span>
                        <span>Group</span>
                        <span>Probability</span>
                    </div>
                    {% for item in ranked_probs %}
                        <div class="table-row">
                            <span>{{ loop.index }}</span>
                            <span>Person {{ item.group }}</span>
                            <span>{{ (item.prob * 100) | round(3) }}%</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="ghost-icon">ðŸ‘¤</div>
                <p>Upload a face image to see the model's prediction.</p>
            </div>
        {% endif %}
    </section>
</main>

<section class="card footnote">
    <div>
        <h3>How it works</h3>
        <p class="dim">
            The FastAPI endpoint scales the image, projects it through PCA,
            assigns a K-Means cluster, concatenates one-hot cluster features,
            and uses a small neural classifier trained on UMIST groups.
        </p>
    </div>
    <div class="stats">
        <div>
            <p class="dim tiny">Expected size</p>
            <strong>112Ã—92</strong>
        </div>
        <div>
            <p class="dim tiny">Classes</p>
            <strong>20 people</strong>
        </div>
        <div>
            <p class="dim tiny">Backend</p>
            <strong>FastAPI + TensorFlow</strong>
        </div>
    </div>
</section>
{% endblock %}
